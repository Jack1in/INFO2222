{% extends 'base.jinja' %}

{% block content %}
<style>
    nav {
        border-bottom: 1px solid black;
        overflow: auto;
    }

    #message_box {
        border: 1px solid black;
        height: 400px;
        width: 800px;
        overflow: auto;
        padding: 2px;
    }

    .text {
        margin-top: 2px;
        margin-bottom: 2px;
    }
</style>

<!-- Navbar, displaying the username and friend functionalities -->
<nav>
    <ol style="float: right">
        <li style="display:inline-block">Username: {{ username }}</li>
    </ol>
    <ul style="float: left">
        <li><strong>Friend Requests:</strong>
            {% if friend_requests %}
                <ul>
                    {% for request in friend_requests %}
                        <li id="request-{{ request.username }}">{{ request.username }}
                            <button onclick="acceptRequest('{{ request.username }}')">Accept</button>
                            <button onclick="rejectRequest('{{ request.username }}')">Reject</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No friend requests.</p>
            {% endif %}
        </li>
        <li><strong>Friends List:</strong>
            <ul id="friends_list">
                {% for friend in friends_list %}
                    <li>{{ friend }}</li>
                {% endfor %}
            </ul>
            {% if not friends_list %}
                <p id="no_friends_msg">No friends yet.</p>
            {% endif %}
        </li>
    </ul>
</nav>

<h1>Messaging App</h1>

<main>
    <!-- The messages are displayed here -->
    <section id="message_box"></section>

    <!-- Chat box for choosing a chat partner -->
    <section id="chat_box">
        <p class="text">Chat with:</p>
        <input id="receiver" placeholder="username">
        <button onclick="join_room()">Chat</button>
    </section>

    <!-- The input box for sending messages, initially hidden -->
    <section id="input_box" style="display: none">
        <p class="text">Message:</p>
        <input id="message" placeholder="message">
        <button onclick="send()">Send</button>
        <button onclick="leave()">Leave Room</button>
    </section>

    <!-- Friend request box for adding new friends -->
    <section id="friend_request_box">
        <p class="text">Add Friend:</p>
        <input id="friend_username" placeholder="Enter friend's username">
        <button onclick="send_friend_request()">Send Friend Request</button>
    </section>
</main>

<script src="/static/js/libs/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/static/js/libs/js.cookie.min.js"></script>
<script>
    let room_id = 0;

    $("#message").on("keyup", (e) => {
        if (e.key == "Enter") {
            send();
        }
    });

    $("#receiver").on("keyup", (e) => {
        if (e.key == "Enter") {
            join_room();
        }
    });

    $(document).ready(() => {
        if (Cookies.get("room_id") === undefined) {
            return;
        }
        $("#chat_box").hide();
        $("#input_box").show();
        room_id = parseInt(Cookies.get("room_id"));
    });

    let username = "{{ username }}";
    Cookies.set('username', username);
    const socket = io();

    socket.on("incoming", (msg, color="black") => {
        add_message(msg, color);
    });

    function send() {
        let message = $("#message").val();
        $("#message").val("");
        socket.emit("send", username, message, room_id);
    }

    function join_room() {
        let receiver = $("#receiver").val();
        socket.emit("join", username, receiver, (res) => {
            if (typeof res != "number") {
                alert(res);
                return;
            }
            room_id = res;
            Cookies.set("room_id", room_id);
            $("#chat_box").hide();
            $("#input_box").show();
        });
    }

    function leave() {
        Cookies.remove("room_id");
        socket.emit("leave", username, room_id);
        $("#input_box").hide();
        $("#chat_box").show();
    }

    function add_message(message, color) {
        let box = $("#message_box");
        let child = $(`<p style="color:${color}; margin: 0px;"></p>`).text(message);
        box.append(child);
    }

    function send_friend_request() {
        let friend_username = $("#friend_username").val();
        $.ajax({
            url: "/send_request",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ sender: "{{ username }}", receiver: friend_username }),
            success: function(response) {
                alert("Request status: " + response.result);
            },
            error: function() {
                alert("Failed to send friend request.");
            }
        });
    }

    function acceptRequest(requestUsername) {
        $.ajax({
            url: "/accept_friend_request",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ sender: requestUsername, receiver: "{{ username }}"}),
            success: function(response) {
                if (response.result === "Friend added successfully.") {
                    $('#friends_list').append(`<li>${requestUsername}</li>`);
                    if ($('#friends_list li').length === 1) {
                        $('#no_friends_msg').remove();  // 如果这是第一个好友，删除"No friends yet"消息
                    }
                    $(`#request-${requestUsername}`).remove();
                    alert("Friend request accepted.");
                } else {
                    alert(response.result);
                }
            },
            error: function() {
                alert("Error processing request.");
            }
        });
    }
    

    function rejectRequest(requestUsername) {
        $.ajax({
            url: "/reject_friend_request",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ sender: requestUsername, receiver: "{{ username }}"}),
            success: function(response) {
                if (response.result === "Friend request rejected.") {
                    $(`#request-${requestUsername}`).remove();
                    alert("Friend request rejected.");
                } else {
                    alert(response.result);
                }
            },
            error: function() {
                alert("Error processing request.");
            }
        });
    }
</script>
{% endblock %}
