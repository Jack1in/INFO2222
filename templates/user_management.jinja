{% extends 'base.jinja' %}

{% block content %}
<style>
    .user-container {
        border: 2px solid #007BFF;
        padding: 15px;
        margin: 10px 0;
        background-color: #f9f9f9;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .user-container:hover {
        background-color: #e0e0e0;
        border-color: #0056b3;
    }

    .user-username {
        font-size: 1.2em;
        font-weight: bold;
    }

    .user-role {
        font-size: 1em;
        color: #555;
    }

    .user-status {
        font-size: 0.9em;
        color: #777;
    }

    .user-actions {
        margin-top: 10px;
    }

    .user-actions button {
        margin-right: 10px;
    }
</style>

<nav>
    <button onclick="window.location.href='{{ url_for('home', username=request.args.get('username'), sessionKey=request.args.get('sessionKey')) }}'">Back to Home page</button>
</nav>

<h1>User Management</h1>

<main>
    <section id="users">
        <h2>Users</h2>
        <div id="users_list">
            <!-- Users will be populated here -->
        </div>
    </section>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        async function loadUsers() {
            try {
                const response = await fetch("{{ url_for('get_users') }}");
                if (response.ok) {
                    const users = await response.json();
                    const usersList = document.getElementById('users_list');
                    usersList.innerHTML = '';

                    users.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-container';
                        userItem.innerHTML = `
                            <div class="user-username">${user.username}</div>
                            <div class="user-role">Role: ${user.role}</div>
                            <div class="user-status">Status: ${user.muted ? 'Muted' : 'Unmuted'}</div>
                            <div class="user-actions">
                                <button onclick="toggleMuteUser('${user.username}', ${user.muted})">${user.muted ? 'Unmute' : 'Mute'}</button>
                            </div>
                        `;
                        usersList.appendChild(userItem);
                    });
                } else {
                    console.error("Failed to load users.");
                }
            } catch (error) {
                console.error("Error loading users:", error);
            }
        }

        async function toggleMuteUser(username, isMuted) {
            const action = isMuted ? 'unmute' : 'mute';
            const sessionKey = "{{ request.args.get('sessionKey') }}";

            try {
                const response = await fetch(`{{ url_for('toggle_mute_user') }}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        username: username,
                        sessionKey: sessionKey,
                        action: action
                    }),
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`User ${action}d successfully!`);
                    loadUsers();
                } else {
                    const errorText = await response.text();
                    console.error(`Failed to ${action} user:`, errorText);
                    alert(`Failed to ${action} user. Server response: ` + errorText);
                }
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                alert(`An error occurred while trying to ${action} the user.`);
            }
        }

        window.toggleMuteUser = toggleMuteUser;
        loadUsers();
    });
</script>
{% endblock %}
