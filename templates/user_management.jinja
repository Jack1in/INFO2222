{% extends 'base.jinja' %}

{% block content %}
<style>

    
    body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
        margin: 0;
        padding: 0;
        padding-top: 50px;
    }

    body.dark-mode {
        background-color: #121212; 
        color: white; 
    }

    nav {
        border-bottom: 1px solid white;
        overflow: auto;
        background-color: #ffffff;
        padding: 10px 0;
        color: black;
    }

    nav.dark-mode {
        border-bottom: 1px solid #121212;
        background-color: #121212; 
        color: white;
    }

    nav ol, nav ul {
        float: right;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    nav ul {
        float: left;
    }

    nav ol li, nav ul li {
        display: inline-block;
        margin-left: 20px;
    }

    nav ol li button, nav ul li button {
        background-color: #4CAF50; 
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    nav ol li button:hover, nav ul li button:hover {
        background-color: #45a049; 
    }

    body.dark-mode nav ol li button, 
    body.dark-mode nav ul li button {
        background-color: #333; 
    }

    body.dark-mode nav ol li button:hover, 
    body.dark-mode nav ul li button:hover {
        background-color: #666; 
    }

    h1 {
        text-align: center;
        margin: 20px 0;
    }

    table {
        width: 80%;
        margin: 20px auto;
        border-collapse: collapse;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    table thead {
        background-color: #000;
        color: white; 
    }

    table thead.dark-mode {
        background-color: #000; 
        color: white; 
    }

    table thead th {
        padding: 15px;
    }

    table tbody tr {
        background-color: white;
        transition: background-color 0.3s;
    }

    table tbody tr.dark-mode {
        background-color: #000; 
    }

    table tbody tr:nth-child(even) {
        background-color: white;
    }

    table tbody tr:nth-child(even).dark-mode {
        background-color: #000; 
    }

    table tbody tr:hover {
        background-color: #f1f1f1;
    }

    table tbody tr:hover.dark-mode {
        background-color: #111; 
    }

    table tbody td {
        padding: 15px;
        text-align: center;
        color: #000;
    }

    table tbody td.dark-mode {
        color: #000; 
    }

    table tbody td button {
        background-color: #4CAF50;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }

    table tbody td button:hover {
        background-color: #45a049;
    }

    body.dark-mode table tbody td button {
        background-color: #555; 
    }

    body.dark-mode table tbody td button:hover {
        background-color: #666;
    }

    table tbody td select {
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
    }

    table tbody tr.dark-mode td {
        background-color: #000; 
    }

    table tbody tr:nth-child(even).dark-mode td {
        background-color: #000; 
    }

    table tbody tr:hover.dark-mode td {
        background-color: #111; 
    }

    nav ul {
        float: left;
        list-style: none;
        padding: 0;
        margin: 0;
        position: absolute;
        top: 10px;
        left: 195px;
    }

    nav ul li {
        display: inline-block;
        margin-left: 5px;
    }

    nav ol {
        position: absolute;
        top: 10px;
        right: 10px;
        list-style: none;
        padding: 0;
        margin: 0;
    }
</style>

<nav>
    <ul>
        <li><button onclick="window.location.href='{{ url_for('home', username=request.args.get('username'), sessionKey=request.args.get('sessionKey'), role=request.args.get('role')) }}'">Home Page</button></li>
    </ul>
    <ol>
        <li style="display:inline-block" id="user-role">Role: {{ role|escape }}</li>
        <li><button onclick="logout()">Logout</button></li>
    </ol>
</nav>

<h1>User Management</h1>

<table>
    <thead>
        <tr>
            <th>Username</th>
            <th>Role</th>
            <th>Online Status</th>
            <th>Muted</th>
            <th>Actions</th>
            <th>Change Role</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr id="user-{{ user.username }}">
            <td>{{ user.username|escape }}</td>
            <td>{{ user.role|escape }}</td>
            <td>{{ user.online_status }}</td>
            <td>{{ user.ismuted }}</td>
            <td>
                <button onclick="toggleMute('{{ user.username|escape }}', {{ 'true' if user.ismuted else 'false' }})">
                    {% if user.ismuted %}
                        Unmute
                    {% else %}
                        Mute
                    {% endif %}
                </button>
            </td>
            <td>
                <select onchange="changeRole('{{ user.username|escape }}', this.value)">
                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                    <option value="academics" {% if user.role == 'academics' %}selected{% endif %}>Academics</option>
                    <option value="administrative staff" {% if user.role == 'administrative staff' %}selected{% endif %}>Administrative Staff</option>
                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                </select>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/static/js/libs/js.cookie.min.js"></script>
<script>
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    document.querySelectorAll('nav').forEach(el => el.classList.toggle('dark-mode'));
    document.querySelectorAll('table thead').forEach(el => el.classList.toggle('dark-mode'));
    document.querySelectorAll('table tbody tr').forEach(el => el.classList.toggle('dark-mode'));
    document.querySelectorAll('table tbody td').forEach(el => el.classList.toggle('dark-mode'));

    if (document.body.classList.contains('dark-mode')) {
        localStorage.setItem('darkMode', 'enabled');
    } else {
        localStorage.setItem('darkMode', 'disabled');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('darkMode') === 'enabled') {
        toggleDarkMode(); 
    }
});

function toggleMute(username, isMuted) {
    let sessionKey = "{{ sessionKey }}";
    let action = isMuted ? "unmute_user" : "mute_user";
    
    console.log(`Action: ${action}, Target User: ${username}`);

    $.ajax({
        url: `/${action}`,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ username: "{{ username|escape }}", targetUser: username, sessionKey: sessionKey }),
        success: function(response) {
            console.log("Success:", response);
            alert(response.message);
            location.reload();  // Reload the page to reflect changes
        },
        error: function(xhr, status, error) {
            console.log("Error:", xhr, status, error);
            alert("Error processing request.");
        }
    });
}

function changeRole(username, newRole) {
    let sessionKey = "{{ sessionKey }}";
    
    console.log(`Change Role: ${username}, New Role: ${newRole}`);

    $.ajax({
        url: `/change_role`,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ username: "{{ username|escape }}", targetUser: username, newRole: newRole, sessionKey: sessionKey }),
        success: function(response) {
            console.log("Success:", response);
            alert(response.message);
            location.reload();  // Reload the page to reflect changes
        },
        error: function(xhr, status, error) {
            console.log("Error:", xhr, status, error);
            alert("Error processing request.");
        }
    });
}

function logout() {
    const username = "{{ username|escape }}";
    const data = { username: username };
    
    fetch('/logout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    }).then(response => {
        if (response.ok) {
            Cookies.remove("username");
            sessionStorage.removeItem('sessionKey');
            window.location.href = "{{ url_for('login') }}";
        } else {
            alert('Logout failed');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('Logout failed');
    });

}

</script>
{% endblock %}
